
#  Tarantool Data Grid: пример
Однажды нам потребовалось оценить состояние рынка недвижимости. 
Для этого мы решили создать продукт, который бы смог провести 
анализ объявлений с нескольких сайтов агентств недвижимости. 
При этом мы хотели иметь возможность подписываться на рассылку 
с новыми предложениями в определенном районе. Таким образом, 
нам нужен был продукт с возможностями:

- получения данных из различных источников,
- обобщения информации,
- анализа.

И именно Tarantool Data Grid помог нам справиться с этими задачами!

## Модели
Для обобщения информации мы ввели три типа данных:
1. Агент, который сдает недвижимость в аренду или продает ее.
2. Сам объект недвижимости.
3. Адрес объекта недвижимости.

У этих трех типов есть соответствующие поля:

1. Агент (Агрегат)
   - Имя
   - Телефон
2. Недвижимость (Агрегат)
   - Действие (продажа, аренда, посуточная аренда)
   - Тип (квартира, комната, дом)
   - Ремонт (отделка, евроремонт и т.д.)
   - Площадь помещения
   - Стоимость
   - Адрес
3. Адрес (Объект-значение)
   - Страна
   - Город
   - Улица
   - Дом
   - Район
   - Станция метро

В качестве параметров для анализа района были выбраны следующие позиции:
   - количество объектов недвижимости,
   - минимальная, максимальная и средняя стоимость.

## Обработка данных
В нашем случае было два источника данных: `Favihome.Com` и `Estate Inc`.

Парсер `Favihome.Com` отправлял данные в формате `JSON` в следующем виде:
- Агент:
  ```json
  {
    "home_id": 12345,
    "name": "John Smith",
    "phone": "+79998887766"
  }
  ```
- Недвижимость:
  ```json
  {
    "home_id": 98765,
    "agent_uuid": "c3f731db-036b-4069-8de3-238c5bcf8df9",
    "action": "buy",
    "type": "flat",
    "square": 75,
    "price": 12000000,
    "address": {
      "country": "Russia",
      "city": "Moscow",
      "metro": "Aeroport",
      "district": "Aeroport"
    }
  }
  ```

Парсер `Estate Inc` отправлял данные в формате `JSON` в следующем виде:
- Агент:
  ```json
  {
    "company": "estate inc",
    "agent": {
      "first_name": "John",
      "last_name": "Smith"
    }
  }
  ```
- Недвижимость:
  ```json
  {
    "company": "estate inc",
    "estate": {
      "agent_uuid": "c3f731db-036b-4069-8de3-238c5bcf8df9",
      "action": "buy",
      "type": "flat",
      "renovation": "european",
      "price": 12000000,
      "street": "Baker Street",
      "building": "221B",
      "district": "Central"
    }
  }
  ```

Далее производилось приведение информации к общему виду (который описан 
в разделе [Модели](#Модели)) с последующим сохранением в репозитории.

## Рассылка по электронной почте
Можно подписаться на уведомления по почте о появлении новых объектов 
недвижимости в определенном районе. Для этого необходимо отправить 
запрос в формате `JSON` со следующими полями:
```json
{
  "type": "subscribe",
  "email": "test@example.com",
  "district": "Aeroport"
}
```

Рассылка писем происходит следующим образом:
1. Информация об объекте недвижимости сохраняется в репозиторий.
2. Эта же информация падает в процессор для вывода данных (`output_processor`).
3. В `output_processor` электронные письма **сразу же** отправляются подписчикам.

## Анализ
Чтобы узнать среднюю стоимость и другую важную информацию по каждому району, 
нужно использовать GraphQL-запрос, подобный этому:
```graphql
{
  DistrictStat {
    district
    count
  }
}
```

Ответ будет выглядеть примерно так:
```json
{
  "data": {
    "DistrictStat": [
      { "district": "Aeroport", "count": 175 },
      { "district": "Dinamo", "count": 285 }
    ]
  }
}
```

При этом ответ содержит предварительно вычисленные статистические данные.
Статистика пересчитывается в следующих случаях:

1. Автоматически запущена задача `update_all_districts_stat`, которая обновляет 
данные по всем районам (она запускается каждые 5 минут).
2. Вручную запущена функция `calc_all_districts_stat` для обновления 
всех статистических данных:
   ```graphql
   {
     calc_all_districts_stat
   }
   ```
3. Вручную запущена функция `calc_district_stat` для обновления данных 
по определенному району. Пример GraphQl-запроса:
   ```graphql
   {
     calc_district_stat(district: "Aeroport")
   }
   ```

## Работа с примером

### Запуск
1. Сначала следует запустить `TDG`. В файле README, который находится 
в корневой директории, описано, как сделать это.
2. Затем следует применить конфигурацию из примера проекта. Для этого необходимо 
запустить `setconfig.py`, указав в качестве аргумента путь к папке с конфигурацией:
   ```bash
   ./setconfig.py example/config
   ```
3. Настройка сервера `TDG` завершена. Чтобы добавить данные, можно запустить 
скрипт для генерации случайных данных:
   ```bash
   example/generator.py -a 100 -e 1000 -t 1
   ```
   Флажок `-a` обозначает количество создаваемых агентов. 
   Флажок `-e` обозначает количество создаваемых объектов недвижимости.
   Флажок `-t` обозначает тип моделируемого ресурса (1 - `Favihome.Com`, 2 - `Estate Inc`)
4. Теперь можно открыть веб-интерфейс (по умолчанию: http://localhost:8080) и работать в нем.
   
### Получение статистических данных по районам
В веб-интерфейсе можно открыть вкладку `GraphQl` и отправить GraphQl-запрос для 
получения данных по первым 10 районам:
```graphql
{
 DistrictStat(first: 10) {
   district
   avg_price
 }
}
```
Кроме того, можно изменить набор выдаваемых полей. Например, можно добавить 
поле `count`. Чтобы понять, какие поля можно добавлять, откройте `models.avsc` 
или просто нажмите `Alt + Enter` в редакторе GraphQl для отображения подсказок. 
**В результате выполнения запроса Вы можете увидеть пустой массив, это нормально.**
Это означает, что после добавления данных еще не была запущена задача по подсчету
статистики. Чтобы вручную выполнить подсчет статистических данных, 
используйте следующий GraphQl-запрос:
```graphql
{
 calc_all_districts_stat
}
```
После этого попробуйте снова получить статистические данные.

### Рассылка по электронной почте
Можно также подписаться на получение уведомлений по электронной почте. 
Но перед этим следует поменять параметры SMTP-соединения в файле `config.yml` 
(раздел `connector.output`) на свои собственные и снова применить конфигурацию, 
как описано во втором пункте в разделе [Запуск](#Запуск). Теперь можно открыть 
вкладку `Test`, выбрать тип запроса `JSON` в верхней части страницы и отправить 
его со следующими полями:
```json
{
 "type": "subscribe",
 "email": "test@example.com",
 "district": "Aeroport"
}
```
Вот и всё! Теперь введенный адрес электронной почты подписан на уведомления 
о новых объектах недвижимости в выбранном районе. Для проверки можно вручную 
добавить некий объект недвижимости. Для этого сначала получите UUID какого-либо
агента с помощью GraphQl-запроса:
```graphql
{
 Agent {
   uuid
 }
}
```
После этого можно отправить запрос в формате `JSON`, например:
```json
{
 "company": "estate inc",
 "estate": {
   "agent_uuid": "HERE ENTER UUID OF AGENT",
   "action": "buy",
   "type": "flat",
   "renovation": "european",
   "price": 12000000,
   "street": "Baker Street",
   "building": "221B",
   "district": "Aeroport"
 }
}
```

### Написание кода
Попробуем добавить еще один обработчик ввода для поддержки третьего источника данных: 
`BestRent.ru`. Этот источник будет отправлять данные в следующем формате:
- Агент:
  ```json
  {
    "best_rent": "agent",
    "data": {
      "name": "John Smith"
    }
  }
  ```
- Недвижимость:
  ```json
  {
    "best_rent": "estate",
    "data": {
      "agent_uuid": "c3f731db-036b-4069-8de3-238c5bcf8df9",
      "type": "flat",
      "price": 12000000,
      "address": {
        "city": "Moscow",
        "district": "Aeroport"
      }
    }
  }
  ```
Здесь видно, что у каждого типа данных есть поле `best_rent`. Это будет 
уникальный параметр, по которому мы определим, что информация поступила 
именно из этого источника. Чтобы добавить правило в классификатор, откройте 
файл [classifier.lua](/example/config/src/input/classifier.lua) и добавьте следующие строки:
```lua
if param.obj.best_rent ~= nil then
    param.routing_key = "best_rent_key"
    return param
end
```
Кроме того, обновить обработчик этих данных. Откройте файл `handler.lua`
в директории [src/](/example/config/src) для редактирования. Добавьте следующие строчки
для определения типа объекта:
```lua
if param.obj.best_rent == "agent" then
    param.routing_key = "agent_key"
end

if param.obj.best_rent == "estate" then
    param.routing_key = "estate_key"
end
```
Кроме того, в поле `obj` нужно записать данные объекта хранения. В нашем случае это просто:
```lua
param.obj = param.obj.data
```
В нашем хранилище у модели должен быть UUID. Чтобы добавить UUID (если его нет), введите:
```lua
local uuid = require('uuid')
if param.obj.uuid == nil then
    param.obj.uuid = uuid.str()
end
```

Итак, мы изменили классификатор и обновили обработчик для преобразования входного
объекта в объект хранения.

Теперь осталось повторно применить конфигурацию, и после этого мы сможем 
протестировать, что у нас получилось! Для тестирования откройте веб-интерфейс 
и отправьте такой `JSON-запрос`:
```json
{
  "best_rent": "agent",
  "data": {
    "uuid": "02dbf839-233d-4abe-8733-7e6739ca2bdb",
    "name": "John Smith"
  }
}
```
Если все в порядке, вы получите в ответ `ok`, а во вкладке `Repair` не будет 
объектов. Также Вы можете отправить этот GraphQl-запрос, чтобы проверить, 
что возвращаемое имя агента - "John Smith":
```graphql
{
  Agent(uuid: "02dbf839-233d-4abe-8733-7e6739ca2bdb") {
    name
  }
}
```
