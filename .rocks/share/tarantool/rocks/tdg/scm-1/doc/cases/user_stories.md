Транзакционное ядро: пользовательские истории
=============================================

Базовые возможности (этап 1, январь 2018)
---------------------------------------------

#### Сервис транзакционной обработки бизнес-объектов

Транзакционное ядро должно предоставить возможность получения бизнес-объектов через интеграционную шину T-Connect. Бизнес-объекты - это объекты, которые рождаются в системах инвестиционного бизнеса, например, это различного рода сделки с валютой и ценными бумагами, ордера по сделкам (приказы, которые отправляются клиентом брокеру на совершение сделки). Обработка входящих объектов в транзакционном ядре должна осуществляться сервисом транзакционной обработки бизнес-объектов. На первом этапе задачей данного сервиса является только сохранение объекта внутри транзакционного ядра в том виде, в котором он был получен из системы-источника, то есть без проверки целостности объекта, без приведения объекта к эталонной модели данных, без авторизации запроса. К каждому отправляемому бизнес-объекту система-источник добавляет набор атрибутов (они располагаются в самом XML-сообщении в фиксированной группе элементов), которые можно использовать в пайплайне для определения, типа объекта, типа сделки (если это сделка), даты отправки из системы-источника и так далее. Эта информация может быть полезной для определения куда именно объект нужно положить в ядро, может быть полезной для построения индексов по этим полям, а также в первой простой версии информационных витрин можно было бы использовать эту информацию как ключи и значения для получения списка объектов. Если по каким-то причинам объект не удалось сохранить в ядре, то его необходимо переместить в ремонтную очередь и одновременно с этим оповестить администратора о возникшей проблеме. Канал оповещения администратора будет уточнен позднее, но, скорее всего, это электронная почта и/или оповещение в интерфейсе администратора в отдельном разделе (список возникших проблем).
На следующих этапах в сервис транзакционной обработки бизнес-объектов планируется добавить механизмы проверки целостности объектов, приведения к эталонной модели данных по заданным правилам и так далее

#### Сервис предоставления данных информационных витрин по подписке

На первом этапе данный сервис не планируется реализовывать, но в дальнейшем этот сервис нужен будет для отправки во внешние системы бизнес-объектов в случае наступления каких-либо событий в транзакционном ядре

#### Сервис предоставления данных информационных витрин по запросу

Так как транзакционное ядро на первом этапе будет только накапливать в себе данные, то реализация полноценного сервиса с конфигуратором витрин не требуется. Но нужен будет один сервис с несколькими методами, которые позволили бы получать:

- Объект целиком по его первичному ключу
- Список объектов

Параметрами, которые могут быть переданы на вход этому методу, могут быть параметры, перечисленные в списке индексов объекта. Также одним из обязательных параметров запроса должно быть количество объектов, которые мы хотим получить на выходе, т.е. выборка должна быть ограничена. К этому можно добавить пейджирование результатов выполнения запроса, например, *дай мне первые 100 результатов, вторые 100 результатов* и так далее

#### Архивное хранилище бизнес-объектов

На первом этапе потребуется базовое архивное хранилище бизнес-объектов. Это хранилище будет развернуто на отдельных серверах, к которым подключена дисковая стойка с большим объемом дискового пространства. В это хранилище на дисковый массив будут дублироваться объекты из оперативной памяти, например, в рамках процедуры закрытия дня. Это требование возникло в связи с тем, что суммарный объем полученных за два-три месяца объектов может превысить доступную оперативную память кластера. Также есть понимание, что объекты с коротким сроком жизни, например, сделки купли-продажи валюты, хранить в оперативном кластере в оперативной памяти после окончания их срока жизни нецелесообразно.

#### Сервис предоставления архивных данных по запросу

Для архивного хранилища бизнес-объектов требуются сервисы получения доступа к данным, построенные по той же структуре, что и сервисы предоставления данных информационных витрин по запросу.

#### Сервис обновлнения информационных витрин

На первом этапе сервис обновлнения информационных витрин не потребуется, но в дальнейшем он будет связан с перестроением материализованных витрин данных

#### Сервис агрегации объемов

На первом этапе сервис агрегации объемов не потребуется, но в дальнейшем он будет необходим для выполнения предрасчетов по коллекциям объектов и сохранения итоговых значений (чтобы при пересчете не ходить глубоко в историю за данными, а использовать некие агрегаты - срезы за неделю, месяц и т.д.)

#### Сервис обработки конца дня

На первом этапе в рамках сервиса обработки конца дня планируется выполнять следующие действия:

- Проверять ремонтную очередь на предмет наличия необработанных сообщений. Если на конец дня очередь не пустая, то должно отправляться оповещение администратору системы, чтобы он исправил эту ситуацию
- Запускать сверку списка идентификаторов имеющихся в ядре объектов и списка идентификаторов объектов, которые по мнению системы-источника были отправлены в ядро. Для этого банковская ETL-система (Modullar) будет опрашивать базы данных систем-источников бизнес-объектов, формировать для каждой системы список отправленных объектов и передавать в ядро через интеграционную шину T-Connect. Задачей ядра является проверка по этим спискам того факта, что все объекты имеются внутри ядра. Если возникает ситуация, что эти внутренний список объектов расходится с внешним списком объектов, то об этом должен оповещаться администратор системы
- Копировать имеющиеся в оперативной памяти ядра объекты в архивное хранилище с целью освобождения оперативной памяти для новых объектов
- Получать от банковской ETL-системы legacy-справочники систем-источников бизнес-объектов и обновлять их у себя (с версионированием)

#### Сервис бизнес-расписаний

На первом этапе в сервисе бизнес-расписаний будет хранится расписание запуска сервиса обработки конца дня и он будет инициировать старт обработки конца дня. В дальнейшем сервис бизнес-расписаний будет связан с генерацией событий, которые могут влиять на репликацию каких-либо данных ядра во внешние системы, загрузку информации и т.д.

#### Сервис администратора

На первом этапе сервис администратора будет включать в себя минимальные возможности по отслеживанию состояния кластера:

- Пользователю должна быть предоставлена возможность мониторинга состояния (dead, alive) нод кластера, отображаемая в графическом интерфейсе пользователя на странице администрирования с цветовой индикацией текущего состояния, то есть, например, в табличке со списком нод живая нода подсвечивается зеленым цветом, утраченная - красным
- Управление кластером - запуск кластера, перезапуск, остановка, управление отдельными нодами - должно также присутствовать в первом этапе. Наличие управляющих элементов в графическом интерфейсе не требутся, достаточно command-line интерфейса (это могут быть встроенные средства докера, энсибл плэйбуки, шелл-скрипты и т.д.)
- Пользователю должна быть предоставлена возможность просмотра содержимого ремонтной очереди из графичекого интерфейса пользователя на странице администрирования. Параметры, которые должны отображаться у каждого объекта в ремонтной очереди - идентификатор объекта, причины попадания в очередь, время попадания в очередь и еще какая-либо служебная информация, которая будет определена позднее совместно с командой сопровождения. Также необходимы контрольные элементы, которые позволяли бы отправить одно сообщение, группу сообщений или все имеющиеся сообщения на повторную обработку в сервис транзакционной обработки событий, а также элементы, которые позволили бы удалять сообщения из очереди поштучно, удалять выбранный набор сообщений или все имеющиеся в очереди сообщения

#### Входные адаптеры

На первом этапе требуется реализация адаптеров, которые могут принимать сообщения по протоколу SOAP и файлы (XML-сообщения размера порядка 100 МБ, по смыслу эти файлы суть справочники систем) по протоколу HTTP. Первыми системами, передающими в шину сообщения по этим протоколам, являются OPICS (position-keeping система по сделкам с валютами) и Modullar (банковская ETL-система, используя которую мы планируем вытаскивать из legacy-систем данные и передавать в ядро) соответственно. В дальнейшем появится источники, использующие REST-протокол, поэтому потребуется входной адаптер REST.

#### Входная очередь

Сообщения, получаемые вышеописанными адаптерами, помещаются во входную FIFO-очередь (на локальное хранение). Требуется возможность проверки состояния этой очереди через интерфейс администратора. Также при превышении размера очереди над заранее заданным значением необходимо оповещать администратора, т.к. это может быть следствием аварийной ситуации.

#### Маршруты сообщений

На первом этапе интеграционная шина должна доставлять сообщения только в транзакционное ядро. Впоследствии, сообщение от любого источника может доставляться во многие системы, поэтому требуется настраиваемый сервис выбора маршрута передачи сообщения на основании параметров этого сообщения.

#### Преобразование сообщений

Если в результате выбора маршрута сообщения был выбран такой выходной адаптер, чей протокол обмена данными отличается от протокола входного адаптера (на первом этапе так как у нас получателем будет только ядро, то маршрут будет только один), то требуется сервис, отвечающий за преобразование сообщения в другой формат. Здесь под преобразованием сообщения понимается только изменение его формата (например из XML в JSON) без изменения бизнес-смысла (не должно происходить изменение значений бизнес-параметров).
Также следует упомянуть справочники систем, получаемые через входной HTTP адаптер. Либо до, либо после передачи справочника в ядро, должен осуществляться разбор этого справочника на отдельные объекты (такую процедуру будем называть парсингом реестров).

#### Выходная очередь

После маршрутизации (не требуется на первом этапе) и преобразования сообщения, оно помещается в FIFO-очередь выходного адаптера (на локальное хранение). Требуется возможность проверки состояния этой очереди через интерфейс администратора. Также при превышении размера очереди над заранее заданным значением необходимо оповещать администратора, т.к. это может быть следствием аварийной ситуации.

#### Выходной адаптер

Сообщение из выходной очереди должно передаваться в пространство хранения в транзакционном ядре. Способ передачи сообщения (протокол выходного адаптера) выбирается на усмотрение разработчика с учетом требования наилучшей эффективности. В целях демонстрации успешной передачи сообщения требуется возможность запросить из ядра переданный объект (для этого используется сервис предоставления данных информационных витрин по запросу).


Модель данных (этап 2, май 2018)
---------------------------------------------


#### Необязательные поля в модели

В языке задания модели должна быть предусмотрена возможность задания поля или целой структуры как необязательных, так как в зависимости от типа объекта или типа события по этому объекту отдельные параметры или группы параметров могут отсутствовать.

#### Простые типы данных

Язык описания модели должен поддерживать простые типы данных, которые свойственны любому языку программирования или языку описания структуры данных. Например, это строки, целые числа, длинные целые числа, числа с плавающей точкой, даты и так далее.

#### Внешние ключи

В инвестиционном бизнесе есть несколько бизнес-справочников, на которые ссылаются сущности. Например, справочник контрагентов, справочник договоров (генеральных соглашений), справочник инструментов и так далее. В сделках присутствуют ссылки на сущности этих справочников, например, в сделке всегда есть ссылка на контрагента, на договор, под которым заключается сделка, а также на инструмент, который является предметом сделки. Транзакционное ядро должно позволять в описании модели данных, а также в языке запросов оперировать ссылками на внешние объекты, указывать по каким именно полям идет связь между объектами, задавать тип отношения сущностей между собой.

#### Индексируемые атрибуты

Для повышения производительности выборок, особенно в условиях объединения (джоинов) объектов, хотелось бы иметь инструмент, аналогичный классическим индексам в СУБД. То есть должна быть возможность помечать поля в модели как обязательные к добавлению в индекс, а также делать составные индексы для полей, по которым чаще всего происходят фильтрация и объединения.

#### Логические условия в фильтрах

Один из сценариев использования языка запросов - построение запросов к данным с накладыванием фильтров. Среди наиболее используемых пользователями фильтров - фильтры, содержащие операнды сравнения (больше, меньше, равно и так далее), логические операнды, позволяющие объединить несколько условий (логические и, или, отрицание)

#### Проверка уникальности значения параметров

У объектов существуют такие параметры, которые должны быть уникальны в рамках множества объектов данного вида. В языке описания модели должна быть возможность помечать такие поля по аналогии с nullable-полями. При этом в момент валидации объекта по модели должна автоматически срабатывать проверка на уникальность.

#### Генерация идентификаторов

В транзакционном ядре у объекта может быть первичный ключ, который не несет смысла с точки зрения бизнеса, но может быть идентификатор, например, номер контрагента, который имеет бизнес-смысл (по этому идентификатору связаны сделки с контрагентами). В том случае, если транзакционное ядро будет мастер-системой по некоторым объектам (например, справочные данные, загруженные с торговой площадки), необходим механизм автоматической генерации бизнес-идентификаторов для новых объектов в момент их появления, чтобы потом можно было ссылаться на эти объекты из других объектов.

#### Витрины данных (нематериализованные)

Для целей бизнеса (регуляторная отчетность, финансовая отчетность, управленческая отчетность) необходимы будут выборки, которые объединяли бы в себе несколько объектов, связанных между собой по внешнему ключу. Например, необходимо будет получать информацию по сделке, а также информацию о контрагенте и параметры инструмента с которым заключена сделка в одном запросе. Также совершенно точно необходимы будут простые арифметические операции над атрибутами объекта (сложение, умножение), отбор значений из атрибута-массива по какому-либо критерию, то есть, своего рода, внутреннее поведение объекта.

#### Проверка внешнего ключа по справочнику при валидации

Бизнес-сущности инвестиционного бизнеса часто имеют ссылки в виде внешних ключей на разного рода справочные данные и другие объекты, например, ссылка на контрагента в сделке, ссылка на контрагента в генеральном соглашении, и так далее. Когда в транзакционное ядро приходит объект, содержащий внешний ключ, должна выполняться автоматическая проверка того, что объект с таким внешним ключом присутствует в транзакционном ядре. Например, когда в систему приходит сделка, в которой есть внешние ключи, один из которых ссылается на контрагента, а другой на инструмент, необходимо проверить существование контрагента и инструмента в транзакционном ядре с такими идентификаторами. В том случае, если внешние ключи проверить не удалось, или по внешним ключам отсутствуют объекты, то пришедший в ядро объект надо отложить в ремонтную очередь и оповестить об этом администратора системы.

#### Валидация модели на этапе загрузки

В процессе создания модели в отсутствие полноценного инструмента редактирования и создания модели крайне велик операционный риск. Для снижения этого риска при загрузке новой версии модели в транзакционное ядро необходимо проводить валидацию модели на соответствие синтаксису, а также проверять зарезервированные выражения на наличие в них недопустимых символов (например, кириллица в названиях индексов).

#### Синтаксический сахар при запросе больших сущностей

В процессе отладки запроса к ядру аналитику для удобства и экономии времени может потребоваться вывести все параметры в границах запрашиваемой сущности без явного указания полного списка параметров. Например, для этих целей можно имплементировать директиву *@all* как указание на то, что в агрегате требуется вернуть все параметры начиная от этой метки до границы агрегата.

#### Аутентификация и авторизация доступа к объектам

Для предотвращения несанкционированного доступа к данным с целью чтения или модификации будет необходим базовый механизм аутентификации и авторизации. Например, система-отправитель запроса на получение данных будет передавать авторизационный токен, который будет периодически перевыпускаться в соответствие с политиками банка.

#### Асинхронный интерфейс для поставщиков данных

В инвестиционном бизнесе существуют системы и класс данных в этих системах, которые не требуют мгновенного подтверждения о сохранении данных в транзакционном ядре. Для такого рода данных и систем необходим асинхронный интерфейс на получение объектов. Под асинхронным интерфейсом имеется в виду то, что при получении сообщения вызывающей системе отправляется http-ответ сразу после сохранения сообщения в очереди на запись, а не после записи в память и дисковый сторадж.

#### Синхронный интерфейс для поставщиков данных

В инвестиционном бизнесе существуют системы и класс данных в этих системах, которые требуют мгновенного подтверждения о сохранении данных в транзакционном ядре. Для такого рода данных и систем необходим синхронный интерфейс на получение объектов. Под синхронным интерфейсом имеется в виду то, что при получении сообщения вызывающей системе отправляется http-ответ только после записи в память и дисковый сторадж в две ноды. Примером такого взаимодействия может быть сохранение данных из пользовательского интерфейса.

#### История и версии

Версия объекта - это определенное состояние структуры объекта. Запись в истории объекта - это определенное состояние значения атрибутов объекта в рамках одной версии объекта. Если обновляется структура объекта, то есть его атрибутивный состав, то меняется версия объекта. Если в рамках одной версии объекта приходит сообщение, которое обновляет часть параметров объекта, то мы получаем запись в историю объекта. Например, простановка штампа о семейном положении в паспорте - это новая запись в истории объекта. Также запланированный перевыпуск паспорта в связи с достижением определенного возраста - тоже запись в историю объекта. Напротив, смена паспорта гражданина СССР на паспорт гражданина РФ - выпуск новой версии паспорта. Таким образом, история объекта накапливается в рамках одной версии объекта. Выпуск новой версии модели повлечет необходимость присылать объекты в новой версии.

#### Обновление объектов в контексте историчности

Все изменения данных в рамках одного агрегата рождают запись в истории этого агрегата. Таким образом, все изменения в рамках сущностей агрегата вмораживаются в историю агрегата и становятся частью его истории. По умолчанию в момент получения объекта из какой-либо системы этот объект валидируется по текущей версии модели. Требования регулятора могут поставить нас в ситуацию, когда объект необходимо отвалидировать по модели и сохранить в модели одной из предыдущих версий. Также может потребоваться трансформация объекта по правилам, которые действовали на определенный момент в прошлом. Для решения подобных ситуаций на входе в транзакционное ядро необходимо определять бизнес-дату создания объекта (содержится в одном из атрибутов объекта) и на основании этой бизнес-даты и даты вступления в силу текущей модели определять можно ли сохранить объект сразу же в текущей модели или его необходимо отложить в очередь ошибок для последующего разрешения ситуации администратором. Для администратора будет необходим инструмент, с помощью которого он сможет управлять ситуациями сохранения объекта в прошлой версии модели. Например, чтобы у него была возможность выбрать версию модели, в которой он хочет сохранить объект. В том случае, если какие-то из сценариев будут часто реализовываться, работу администратора можно будет упростить путем написания эвристических алгоритмов для самых частых случаев.

#### Связь объектов в контексте историчности

По умолчанию все запросы к витринам транзакционного ядра отрабатываются в текущей версии модели на текущую дату. В том случае, если требуется выполнять исторические запросы, то необходимо запросить с сервера интроспекцию модели на тот горизонт дат, на которые необходимо выполнять запросы. Пользователь сначала должен запросить с сервера списка исторических срезов (дат, когда менялась модель), чтобы потом использовать эти срезы для работы с историческими данными. Потом он должен выбрать дату (диапазон), в котором он хочет пользоваться интроспекцией и делать запросы. После определения исторического горизонта можно воспользоваться http-хедером, в котором при запросе интроспекции и при запросах данных будет указываться дата или диапазон дат. В том случае, если мы хотим получить сделку по идентификатору, дополнив ее данными контрагента, то, по умолчанию, историческая сделка будет дополнена данными контрагента, актуальными на текущий момент (даже если они менялись с момента заведения сделки). Если же требуется дополнять сделку данными контрагента, актуальными на момент заведения сделки, то надо предварительно определять временной горизонт, на который будет выполняться запрос и только потом выполнять запрос (явно использовать режим историчности). Если мы хотим получать объекты в текущей модели, то это можно будет сделать в том случае, если список запрашиваемых параметров совместим с предыдущими версиями модели, например, запрос списка сделок с датой сделки и идентификатором сделки. При обновлении модели не требуется пользоваться какими-либо workaround'ами с типами avro, достаточно просто менять структуру, добавляя группы и параметры в группах. Для лучшей обратной совместимости версий моделей и систем-потребителей данных желательно неубавлять поля в группах.

#### Внутреннее поведение объектов

Для задания дополнительного поведения на уровне отдельного объекта должна быть возможность пользоваться функциями на языке lua, которые можно было бы сделать доступными в языке запросов в виде виртуальных полей. Под виртуальным полем имеется в виду поле, которое не хранится отдельно, а вычисляется в момент запроса к данным. Но вся логика этих полей инкапсулируется и для внешнего потребителя виртуальное поле будет неотличимо от обычного. Примером функции, реулизующей дополнительное поведение, может быть поиск значения по какому-либо критерию в параметре с типом массив и вывод найденного значения как значения параметра. На уровне языка описания модели для объявления виртуальных полей можно использовать раздел functions, который будет устроен по аналогии с разделом relations. В разделе functions можно будет задать имя виртуального поля, наименование функции, которая будет выполняться при обращении к этому полю. В логике функции можно будет описать любое математическое выражение, аргументом этой функции будет являться сам объект со всеми его полями.

#### Представления

Для того, чтобы рассмотреть объект со всех сторон, пользователь может захотеть пользоваться представлениями, которые объединяют в себе некий список параметров, сгруппированный в соответствие с каким-либо смыслом. Примером такого представления может быть *группа фронт-офисных параметров*, *группа бэк-офисных параметров*, *группа параметров для расчета риск-показателей* и так далее. Такие группы призваны упростить взаимодействия пользователя с ядром без погружения в полную структуру данных. Также на уровне представлений может потребоваться разграничение доступа (авторизация). Для описания представлений в языке модели можно добавить раздел views, аналогичный разделу relations, в котором можно было бы указывать наименование виртуального поля у агрегата, к которому был бы привязан value object, не являющийся частью структуры агрегата, а являющийся лишь списком параметров представления. В таком случае изменение состава представления не вызовет обновления структуры хранения объекта, а запросы представлений с точки зрения потребителей данных не будут отличаться от получения параметров из структуры объекта.

#### Фабрика объектов

Фабрика объектов - это инструмент для ситуации, когда необходимо на основании имеющихся в транзакционном ядре данных сгенерировать по расписанию или какому-либо событию новый объект. Например, с точки зрения регуляторного репортинга и системы, реализующий процесс регуляторного репортинга, корректнее было бы отдавать объект сделка, дополненный всеми необходимыми данными контрагента и генерального соглашения.
